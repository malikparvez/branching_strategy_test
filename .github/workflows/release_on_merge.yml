name: Pull Request Merge to Release Prep

on:
  pull_request:
    types:
      - closed

jobs:
  if_merged:
    if: github.event.pull_request.merged == true && startsWith(github.head_ref, 'release-prep')
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: "Get version"
        id: "get_version"
        run: |
            version=$(grep -o "version = '[^']*'" .version | awk -F"'" '{print $2}')
            echo "version=$version" >> $GITHUB_OUTPUT
            first_one_digit=$(echo $version | cut -d'.' -f1)
            last_two_digits=$(echo $version | rev | cut -d'.' -f-2 | rev)
            if [[ $last_two_digits != "0.0" ]]; then
              echo "minor"
              echo $last_two_digits
              echo "base_branch=$first_one_digit.0.0" >> $GITHUB_OUTPUT
            else
              echo "major"
              echo $first_one_digit
              echo "base_branch=main" >> $GITHUB_OUTPUT
            fi
      - name: "Create release"
        run: |
          echo "$base_branch"
          gh release create v${{ steps.get_version.outputs.version }} --title v${{ steps.get_version.outputs.version }} --target ${{ steps.get_version.outputs.base_branch }}
          git branch
          ls -lah
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

